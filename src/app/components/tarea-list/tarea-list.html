<div class="container pb-5">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0 fw-bold" style="color: #607d8b;">Tablero Principal</h4>
    <button class="btn btn-primary rounded-circle shadow-sm d-flex align-items-center justify-content-center"
            style="width: 45px; height: 45px; font-size: 24px;"
            routerLink="/tareas/nuevo">
      +
    </button>
  </div>

  <div class="row g-3">
    @for (t of tareas; track t.id) {
      <div class="col-12">
        <div class="card custom-card h-100 p-2">

          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <h5 class="card-title fw-bold mb-1" style="color: #37474f;">{{ t.titulo }}</h5>
                <p class="text-secondary small mb-2">{{ t.descripcion }}</p>
              </div>

              <div class="dropdown ms-2">
                <button class="btn btn-link text-secondary p-0 text-decoration-none" style="font-size: 1.5rem; line-height: 0.5;" type="button" data-bs-toggle="dropdown">
                  ...
                </button>
                <ul class="dropdown-menu dropdown-menu-end border-0 shadow-sm">
                  <li><a class="dropdown-item small" [routerLink]="['/tareas/editar', t.id]">Editar</a></li>
                  <li><a class="dropdown-item small text-danger" (click)="eliminarTarea(t.id!)">Eliminar</a></li>
                </ul>
              </div>
            </div>

            @if(t.pasos && t.pasos.length > 0) {
              <div class="d-flex align-items-center mt-2 mb-3">
                <div class="progress flex-grow-1" style="height: 4px; background-color: #f1f3f5;">
                  <div class="progress-bar" role="progressbar"
                       [style.width.%]="getProgreso(t)"
                       [style.background-color]="getProgreso(t) === 100 ? '#4caf50' : '#90a4ae'">
                  </div>
                </div>
                <span class="ms-2 small text-muted" style="font-size: 0.75rem;">{{ getProgreso(t) }}%</span>
              </div>
            }

            <button class="btn btn-light btn-sm w-100 text-secondary small bg-transparent border-0" type="button"
                    (click)="toggleAcordeon(t.id!)"
                    style="border-top: 1px solid #f8f9fa !important;">
              {{ estaAbierto(t.id!) ? 'Ocultar' : 'Ver checklist (' + (t.pasos?.length || 0) + ')' }}
              <span style="font-size: 0.7rem;">{{ estaAbierto(t.id!) ? '▲' : '▼' }}</span>
            </button>

            <div class="collapse mt-2" [class.show]="estaAbierto(t.id!)">
              <ul class="list-group list-group-flush">
                @for (paso of t.pasos; track $index) {
                  <li class="list-group-item border-0 px-0 py-1 d-flex align-items-center">
                    <input class="form-check-input me-3" type="checkbox"
                           style="cursor: pointer;"
                           [(ngModel)]="paso.completado"
                           (change)="actualizarEstado(t)">

                    <span [class.text-decoration-line-through]="paso.completado"
                          [class.text-muted]="paso.completado"
                          style="font-size: 0.9rem; color: #546e7a;">
                      {{ paso.descripcion }}
                    </span>
                  </li>
                }
              </ul>
            </div>

          </div>
        </div>
      </div>
    } @empty {
      <div class="col-12 text-center mt-5">
        <div class="p-4 rounded bg-white text-muted">
          <p class="mb-0">Todo limpio por aquí.</p>
        </div>
      </div>
    }
  </div>
</div>
